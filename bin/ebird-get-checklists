#!/usr/bin/env python

"""
Command-line script to scape the web page(s) of one or more checklists and
save the data in JSON format to a file.

"""

# TODO Configure logging
# TODO Verify the logging message format is the one we want - probably need to add more fields.

import datetime
import json

from cli.log import LoggingApp

from ebird.pages import get_checklist


class JSONDateEncoder(json.JSONEncoder):

    def default(self, o):
        if isinstance(o, datetime.datetime):
            return o.isoformat()
        else:
            super().default(o)


@LoggingApp(message_format="%(levelname)s: %(message)s")
def script(app):

    encoder = JSONDateEncoder()

    fileout = app.params.fileout
    identifiers = app.params.identifiers

    with open(fileout, 'w') as fp:
        for identifier in identifiers:
            values = get_checklist(identifier)
            json.dump(values, fp, indent=4, default=encoder.default)

script.add_param("identifiers", nargs='+', type=str,
                 help="the identifier for each checklist")

script.add_param("-o", "--output-file", dest='fileout', action="store",
                 default='checklists.json',
                 help="file where the checklist will be saved")

if __name__ == "__main__":
    script.run()
